# 🔧 故障排查指南

## 当前状态

- ✅ Railway 显示 "COMPLETED"（部署完成）
- ❌ API 返回 502 错误（应用无法响应）

这说明部署过程完成了，但应用可能：
1. 启动后立即崩溃
2. 没有正确监听端口
3. 无法处理请求

---

## 🔍 检查步骤

### 1. 查看 Railway 日志

在 Railway 中：
1. 点击 "View logs"
2. 查看最新的日志输出
3. 查找以下信息：

**正常情况应该看到**：
```
服务器运行在端口 3001
当前工作目录: /app
__dirname: /app/backend
```

**如果有错误，可能看到**：
- `加载依赖失败: ...`
- `未捕获的异常: ...`
- `Error: Cannot find module ...`

### 2. 检查环境变量

在 Railway 的 Variables 中，确保设置了：

| 变量名 | 必需 | 说明 |
|--------|------|------|
| `PASSWORD` | ✅ | 登录密码 |
| `SESSION_SECRET` | ✅ | Session 密钥（至少32字符） |
| `NODE_ENV` | ✅ | 设置为 `production` |
| `PORT` | ❌ | Railway 会自动设置 |
| `ALLOWED_ORIGINS` | ⚠️ | 等前端部署后再设置 |

### 3. 检查端口配置

Railway 会自动设置 `PORT` 环境变量，代码应该使用：
```javascript
const PORT = process.env.PORT || 3001;
```

这已经正确配置了。

### 4. 检查启动命令

在 Railway 的 Settings 中，确保：
- **Start Command**: `node backend/server.js`
- 或者留空（使用 `.nixpacks.toml` 中的配置）

---

## 🛠️ 常见问题解决

### 问题 1：服务启动后立即崩溃

**可能原因**：
- 缺少环境变量
- 模块加载失败
- 语法错误

**解决方法**：
1. 查看 Railway 日志中的错误信息
2. 检查所有环境变量是否设置
3. 确保所有依赖都已安装

### 问题 2：端口监听失败

**可能原因**：
- PORT 环境变量未设置
- 端口被占用

**解决方法**：
- Railway 会自动设置 PORT，代码已正确处理

### 问题 3：模块找不到

**可能原因**：
- npm install 失败
- 依赖未正确安装

**解决方法**：
1. 检查构建日志，确认 `npm install` 成功
2. 查看是否有依赖安装错误

---

## 📋 需要提供的信息

如果问题仍然存在，请提供：

1. **Railway 日志**（完整的最新日志）
2. **环境变量列表**（隐藏敏感信息）
3. **构建日志**（如果有错误）
4. **服务状态**（Running/Crashed/Stopped）

---

## 🚀 快速修复尝试

### 方法 1：重启服务

在 Railway 中：
1. 点击服务
2. 点击 "Restart" 按钮
3. 等待重启完成
4. 再次测试 API

### 方法 2：检查日志

1. 点击 "View logs"
2. 复制最新的错误信息
3. 根据错误信息修复问题

### 方法 3：重新部署

1. 在 Railway 中点击 "Redeploy"
2. 选择最新的提交
3. 等待部署完成
4. 检查日志

---

## ✅ 验证清单

部署成功后，应该满足：

- [ ] Railway 显示 "COMPLETED"
- [ ] 日志显示 "服务器运行在端口 XXX"
- [ ] API `/api/health` 返回 `{"status":"ok"}`
- [ ] 没有错误或崩溃信息
- [ ] 服务状态显示 "Running"

---

如果以上都满足，说明部署成功！🎉




